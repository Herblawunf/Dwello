# House Analytics Migration Guide

This document outlines the migration from the old analytics tables to the new `house_analytics` and `houses` tables.

## New Database Schema

### Houses Table
```sql
create table public.houses (
  house_id uuid not null default gen_random_uuid(),
  landlord_id uuid not null,
  street_address text null,
  postcode text null,
  code bigint generated by default as identity not null,
  image text null,
  constraint houses_pkey primary key (house_id),
  constraint houses_postcode_check check ((length(postcode) <= 10))
);
```

### House Analytics Table
```sql
create table public.house_analytics (
  id serial not null,
  house_id character varying(255) not null,
  house_name character varying(255) not null,
  record_date date not null,
  month integer not null,
  year integer not null,
  gross_income numeric not null,
  total_expenses numeric not null,
  net_profit numeric not null,
  maintenance_costs numeric not null,
  tenant_satisfaction numeric not null,
  occupancy_rate numeric not null,
  property_value numeric not null,
  yield_rate numeric not null,
  vacancy_rate numeric not null,
  avg_tenancy_length numeric not null,
  maintenance_cost_ratio numeric not null,
  rent_to_value_ratio numeric not null,
  created_at timestamp with time zone not null default now(),
  constraint house_analytics_pkey primary key (id)
);
```

## Key Changes Made

### 1. DataProvider.jsx
- **Before**: Used `analyticsApi` helper functions and `properties` table
- **After**: Direct Supabase queries to `houses` and `house_analytics` tables
- **Changes**:
  - Replaced `properties` state with `houses`
  - Replaced `propertyMetrics` with `houseMetrics`
  - Added user authentication context to filter by `landlord_id`
  - Implemented direct data aggregation from `house_analytics` table
  - Added helper functions for data processing and formatting

### 2. Metric Details (metric_details.jsx)
- **Before**: Queried `property_analytics` table
- **After**: Queries `house_analytics` table
- **Changes**:
  - Updated table name from `property_analytics` to `house_analytics`
  - Updated field references from `property_id` to `house_id`
  - Updated field references from `property_name` to `house_name`

### 3. Insights (insights.jsx)
- **Before**: Used `properties` and `propertyMetrics`
- **After**: Uses `houses` and `houseMetrics`
- **Changes**:
  - Updated state variable names and references
  - Updated property selection logic to use `house_id`
  - Maintained backward compatibility with `properties` alias

### 4. Dashboard (index.jsx)
- **Before**: Used `properties` array
- **After**: Uses `houses` array
- **Changes**:
  - Updated property count display to use `houses.length`
  - Maintained backward compatibility

## Data Population

To populate the new tables with sample data, use the provided script:

```bash
node populate-house-analytics.js
```

This script will:
1. Create sample houses for a test landlord
2. Generate 6 months of analytics data for each house
3. Insert realistic financial and performance metrics

## Migration Steps

1. **Create the new tables** using the provided SQL schema
2. **Run the population script** to add sample data
3. **Update your environment** to ensure Supabase credentials are correct
4. **Test the application** to ensure all features work with the new data structure

## Backward Compatibility

The refactored code maintains backward compatibility by:
- Keeping `properties` as an alias for `houses`
- Keeping `propertyMetrics` as an alias for `houseMetrics`
- Maintaining the same data structure for components

## Field Mapping

| Old Field | New Field | Notes |
|-----------|-----------|-------|
| `property_id` | `house_id` | UUID identifier |
| `property_name` | `house_name` | Display name |
| `gross_income` | `gross_income` | Same field |
| `total_expenses` | `total_expenses` | Same field |
| `net_profit` | `net_profit` | Same field |
| `maintenance_costs` | `maintenance_costs` | Same field |
| `tenant_satisfaction` | `tenant_satisfaction` | Same field |
| `occupancy_rate` | `occupancy_rate` | Same field |
| `property_value` | `property_value` | Same field |
| N/A | `yield_rate` | New field |
| N/A | `vacancy_rate` | New field |
| N/A | `avg_tenancy_length` | New field |
| N/A | `maintenance_cost_ratio` | New field |
| N/A | `rent_to_value_ratio` | New field |

## Testing

After migration, test the following features:
1. Dashboard overview metrics
2. Property-specific insights
3. Metric details pages
4. Financial charts
5. Maintenance cost breakdowns
6. Time period filtering (Monthly/Quarterly/Annual)

## Troubleshooting

### Common Issues

1. **No data showing**: Ensure the `landlord_id` in the population script matches a real user
2. **Authentication errors**: Check Supabase credentials in environment variables
3. **Missing houses**: Verify the `houses` table has data for the current user
4. **Analytics not loading**: Check that `house_analytics` table has records for the houses

### Debug Commands

```javascript
// Check houses for current user
const { data: houses } = await supabase
  .from('houses')
  .select('*')
  .eq('landlord_id', userId);

// Check analytics data
const { data: analytics } = await supabase
  .from('house_analytics')
  .select('*')
  .limit(5);
``` 